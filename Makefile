# ============================================================================
# SPTRANS PIPELINE - MAKEFILE
# ============================================================================
# Comandos √∫teis para gerenciamento do projeto
# 
# Uso: make <comando>
# Exemplo: make start
# ============================================================================

.PHONY: help install start stop restart logs clean test backup restore build deploy

# Vari√°veis
PROJECT_NAME = sptrans-pipeline
DOCKER_COMPOSE = docker-compose
PYTHON = python3
PIP = pip3

# Cores para output
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m # No Color

# ============================================================================
# HELP
# ============================================================================

help: ## Mostra esta mensagem de ajuda
	@echo ""
	@echo "$(BLUE)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(BLUE)‚ïë                                                              ‚ïë$(NC)"
	@echo "$(BLUE)‚ïë         SPTRANS PIPELINE - COMANDOS DISPON√çVEIS              ‚ïë$(NC)"
	@echo "$(BLUE)‚ïë                                                              ‚ïë$(NC)"
	@echo "$(BLUE)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

# ============================================================================
# SETUP E INSTALA√á√ÉO
# ============================================================================

install: ## Instala todas as depend√™ncias
	@echo "$(BLUE)üì¶ Instalando depend√™ncias...$(NC)"
	$(PIP) install -r requirements.txt
	@echo "$(GREEN)‚úÖ Depend√™ncias instaladas com sucesso!$(NC)"

setup: ## Executa setup inicial completo do projeto
	@echo "$(BLUE)üöÄ Executando setup inicial...$(NC)"
	chmod +x scripts/*.sh
	./scripts/setup.sh
	@echo "$(GREEN)‚úÖ Setup conclu√≠do!$(NC)"

env: ## Cria arquivo .env a partir do .env.example
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "$(GREEN)‚úÖ Arquivo .env criado! Configure suas vari√°veis.$(NC)"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  Arquivo .env j√° existe$(NC)"; \
	fi

# ============================================================================
# DOCKER & SERVICES
# ============================================================================

build: ## Build de todas as imagens Docker
	@echo "$(BLUE)üèóÔ∏è  Building Docker images...$(NC)"
	$(DOCKER_COMPOSE) build
	@echo "$(GREEN)‚úÖ Images criadas com sucesso!$(NC)"

start: ## Inicia todos os servi√ßos
	@echo "$(BLUE)üöÄ Iniciando servi√ßos...$(NC)"
	./scripts/start_services.sh

stop: ## Para todos os servi√ßos
	@echo "$(YELLOW)üõë Parando servi√ßos...$(NC)"
	./scripts/stop_services.sh

restart: stop start ## Reinicia todos os servi√ßos
	@echo "$(GREEN)‚úÖ Servi√ßos reiniciados!$(NC)"

ps: ## Lista status dos containers
	@echo "$(BLUE)üìä Status dos containers:$(NC)"
	$(DOCKER_COMPOSE) ps

logs: ## Mostra logs de todos os servi√ßos
	$(DOCKER_COMPOSE) logs -f

logs-airflow: ## Mostra logs do Airflow
	$(DOCKER_COMPOSE) logs -f airflow-webserver airflow-scheduler

logs-spark: ## Mostra logs do Spark
	$(DOCKER_COMPOSE) logs -f spark-master spark-worker-1 spark-worker-2

logs-postgres: ## Mostra logs do PostgreSQL
	$(DOCKER_COMPOSE) logs -f postgres

# ============================================================================
# ACESSO AOS SERVI√áOS
# ============================================================================

airflow: ## Abre Airflow no navegador
	@echo "$(BLUE)üåê Abrindo Airflow...$(NC)"
	@echo "$(GREEN)http://localhost:8080$(NC)"
	@echo "User: admin | Password: admin"
	@python3 -m webbrowser http://localhost:8080 2>/dev/null || \
	xdg-open http://localhost:8080 2>/dev/null || \
	open http://localhost:8080 2>/dev/null || \
	echo "Abra manualmente: http://localhost:8080"

spark: ## Abre Spark UI no navegador
	@echo "$(BLUE)üåê Abrindo Spark UI...$(NC)"
	@echo "$(GREEN)http://localhost:8081$(NC)"
	@python3 -m webbrowser http://localhost:8081 2>/dev/null || \
	xdg-open http://localhost:8081 2>/dev/null || \
	open http://localhost:8081 2>/dev/null || \
	echo "Abra manualmente: http://localhost:8081"

minio: ## Abre MinIO console no navegador
	@echo "$(BLUE)üåê Abrindo MinIO Console...$(NC)"
	@echo "$(GREEN)http://localhost:9001$(NC)"
	@echo "User: admin | Password: miniopassword123"
	@python3 -m webbrowser http://localhost:9001 2>/dev/null || \
	xdg-open http://localhost:9001 2>/dev/null || \
	open http://localhost:9001 2>/dev/null || \
	echo "Abra manualmente: http://localhost:9001"

grafana: ## Abre Grafana no navegador
	@echo "$(BLUE)üåê Abrindo Grafana...$(NC)"
	@echo "$(GREEN)http://localhost:3000$(NC)"
	@echo "User: admin | Password: admin"
	@python3 -m webbrowser http://localhost:3000 2>/dev/null || \
	xdg-open http://localhost:3000 2>/dev/null || \
	open http://localhost:3000 2>/dev/null || \
	echo "Abra manualmente: http://localhost:3000"

superset: ## Abre Superset no navegador
	@echo "$(BLUE)üåê Abrindo Superset...$(NC)"
	@echo "$(GREEN)http://localhost:8088$(NC)"
	@echo "User: admin | Password: admin"
	@python3 -m webbrowser http://localhost:8088 2>/dev/null || \
	xdg-open http://localhost:8088 2>/dev/null || \
	open http://localhost:8088 2>/dev/null || \
	echo "Abra manualmente: http://localhost:8088"

# ============================================================================
# DATABASE
# ============================================================================

db-shell: ## Acessa shell do PostgreSQL
	@echo "$(BLUE)üóÑÔ∏è  Acessando PostgreSQL...$(NC)"
	$(DOCKER_COMPOSE) exec postgres psql -U airflow -d airflow

db-create-tables: ## Cria tabelas da serving layer
	@echo "$(BLUE)üóÑÔ∏è  Criando tabelas...$(NC)"
	$(DOCKER_COMPOSE) exec -T postgres psql -U airflow -d airflow < sql/01_serving_schema.sql
	$(DOCKER_COMPOSE) exec -T postgres psql -U airflow -d airflow < sql/02_serving_tables.sql
	@echo "$(GREEN)‚úÖ Tabelas criadas!$(NC)"

db-create-views: ## Cria views materializadas
	@echo "$(BLUE)üóÑÔ∏è  Criando views...$(NC)"
	$(DOCKER_COMPOSE) exec -T postgres psql -U airflow -d airflow < sql/03_materialized_views.sql
	@echo "$(GREEN)‚úÖ Views criadas!$(NC)"

db-backup: ## Faz backup do banco de dados
	@echo "$(BLUE)üíæ Fazendo backup...$(NC)"
	./scripts/backup_data.sh
	@echo "$(GREEN)‚úÖ Backup conclu√≠do!$(NC)"

# ============================================================================
# DATALAKE
# ============================================================================

minio-shell: ## Acessa MinIO Client (mc)
	@echo "$(BLUE)üì¶ Acessando MinIO Client...$(NC)"
	$(DOCKER_COMPOSE) exec minio sh

minio-list-bronze: ## Lista arquivos na camada Bronze
	@echo "$(BLUE)üìä Listando Bronze Layer...$(NC)"
	$(DOCKER_COMPOSE) exec minio mc ls local/sptrans-datalake/bronze/ --recursive

minio-list-silver: ## Lista arquivos na camada Silver
	@echo "$(BLUE)üìä Listando Silver Layer...$(NC)"
	$(DOCKER_COMPOSE) exec minio mc ls local/sptrans-datalake/silver/ --recursive

minio-list-gold: ## Lista arquivos na camada Gold
	@echo "$(BLUE)üìä Listando Gold Layer...$(NC)"
	$(DOCKER_COMPOSE) exec minio mc ls local/sptrans-datalake/gold/ --recursive

# ============================================================================
# TESTES
# ============================================================================

test: ## Executa todos os testes
	@echo "$(BLUE)üß™ Executando testes...$(NC)"
	$(PYTHON) -m pytest tests/ -v --cov=src --cov-report=html
	@echo "$(GREEN)‚úÖ Testes conclu√≠dos!$(NC)"

test-unit: ## Executa testes unit√°rios
	@echo "$(BLUE)üß™ Executando testes unit√°rios...$(NC)"
	$(PYTHON) -m pytest tests/unit/ -v

test-integration: ## Executa testes de integra√ß√£o
	@echo "$(BLUE)üß™ Executando testes de integra√ß√£o...$(NC)"
	$(PYTHON) -m pytest tests/integration/ -v

test-coverage: ## Gera relat√≥rio de cobertura
	@echo "$(BLUE)üìä Gerando relat√≥rio de cobertura...$(NC)"
	$(PYTHON) -m pytest tests/ --cov=src --cov-report=html --cov-report=term
	@echo "$(GREEN)‚úÖ Relat√≥rio dispon√≠vel em htmlcov/index.html$(NC)"

lint: ## Executa linter (flake8)
	@echo "$(BLUE)üîç Executando linter...$(NC)"
	$(PYTHON) -m flake8 src/ tests/ dags/
	@echo "$(GREEN)‚úÖ Linting conclu√≠do!$(NC)"

format: ## Formata c√≥digo com black
	@echo "$(BLUE)‚ú® Formatando c√≥digo...$(NC)"
	$(PYTHON) -m black src/ tests/ dags/
	@echo "$(GREEN)‚úÖ C√≥digo formatado!$(NC)"

# ============================================================================
# JUPYTER
# ============================================================================

notebook: ## Inicia Jupyter Lab
	@echo "$(BLUE)üìì Iniciando Jupyter Lab...$(NC)"
	$(PYTHON) -m jupyter lab notebooks/

# ============================================================================
# DADOS E BACKUP
# ============================================================================

backup: ## Backup completo (DB + Data Lake)
	@echo "$(BLUE)üíæ Iniciando backup completo...$(NC)"
	./scripts/backup_data.sh --full
	@echo "$(GREEN)‚úÖ Backup completo conclu√≠do!$(NC)"

backup-incremental: ## Backup incremental (√∫ltimas 24h)
	@echo "$(BLUE)üíæ Iniciando backup incremental...$(NC)"
	./scripts/backup_data.sh --incremental
	@echo "$(GREEN)‚úÖ Backup incremental conclu√≠do!$(NC)"

restore: ## Restaura backup (uso: make restore BACKUP=nome_do_backup)
	@if [ -z "$(BACKUP)" ]; then \
		echo "$(RED)‚ùå Erro: Especifique o backup$(NC)"; \
		echo "Uso: make restore BACKUP=sptrans_backup_20250101_120000"; \
		exit 1; \
	fi
	@echo "$(YELLOW)‚ö†Ô∏è  Restaurando backup: $(BACKUP)$(NC)"
	./scripts/restore_data.sh $(BACKUP)

# ============================================================================
# LIMPEZA
# ============================================================================

clean: ## Remove arquivos tempor√°rios e cache
	@echo "$(YELLOW)üßπ Limpando arquivos tempor√°rios...$(NC)"
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.log" -delete
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".coverage" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Limpeza conclu√≠da!$(NC)"

clean-all: clean ## Remove tudo (containers, volumes, imagens)
	@echo "$(RED)‚ö†Ô∏è  ATEN√á√ÉO: Isso vai remover TODOS os dados!$(NC)"
	@read -p "Tem certeza? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo "$(YELLOW)üßπ Removendo containers, volumes e imagens...$(NC)"
	$(DOCKER_COMPOSE) down -v --remove-orphans
	docker system prune -af --volumes
	@echo "$(GREEN)‚úÖ Tudo removido!$(NC)"

# ============================================================================
# MONITORAMENTO
# ============================================================================

status: ## Mostra status completo do sistema
	@echo ""
	@echo "$(BLUE)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(BLUE)‚ïë                 STATUS DO SISTEMA                            ‚ïë$(NC)"
	@echo "$(BLUE)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@echo "$(YELLOW)üê≥ Docker Containers:$(NC)"
	@$(DOCKER_COMPOSE) ps
	@echo ""
	@echo "$(YELLOW)üíæ Uso de Disco:$(NC)"
	@df -h | grep -E "Filesystem|/var/lib/docker|sptrans" || echo "N/A"
	@echo ""
	@echo "$(YELLOW)üåê URLs de Acesso:$(NC)"
	@echo "  ‚Ä¢ Airflow:   $(GREEN)http://localhost:8080$(NC)"
	@echo "  ‚Ä¢ Spark UI:  $(GREEN)http://localhost:8081$(NC)"
	@echo "  ‚Ä¢ MinIO:     $(GREEN)http://localhost:9001$(NC)"
	@echo "  ‚Ä¢ Grafana:   $(GREEN)http://localhost:3000$(NC)"
	@echo "  ‚Ä¢ Superset:  $(GREEN)http://localhost:8088$(NC)"
	@echo ""

health: ## Verifica sa√∫de dos servi√ßos
	@echo "$(BLUE)üè• Verificando sa√∫de dos servi√ßos...$(NC)"
	@echo ""
	@echo "$(YELLOW)Airflow:$(NC)"
	@curl -s http://localhost:8080/health | grep -q "healthy" && echo "  $(GREEN)‚úÖ OK$(NC)" || echo "  $(RED)‚ùå Falha$(NC)"
	@echo "$(YELLOW)MinIO:$(NC)"
	@curl -s http://localhost:9000/minio/health/live | grep -q "OK" && echo "  $(GREEN)‚úÖ OK$(NC)" || echo "  $(RED)‚ùå Falha$(NC)"
	@echo ""

metrics: ## Mostra m√©tricas Prometheus
	@echo "$(BLUE)üìä M√©tricas (√∫ltimas 5 minutos):$(NC)"
	@curl -s http://localhost:9090/api/v1/query?query=up | jq . 2>/dev/null || echo "Prometheus n√£o dispon√≠vel"

# ============================================================================
# DESENVOLVIMENTO
# ============================================================================

dev: ## Modo desenvolvimento (com hot reload)
	@echo "$(BLUE)üîß Iniciando modo desenvolvimento...$(NC)"
	$(DOCKER_COMPOSE) -f docker-compose.yml -f docker-compose.dev.yml up

shell: ## Acessa shell do container principal
	@echo "$(BLUE)üêö Acessando shell...$(NC)"
	$(DOCKER_COMPOSE) exec airflow-webserver bash

spark-shell: ## Acessa Spark shell
	@echo "$(BLUE)‚ö° Acessando Spark shell...$(NC)"
	$(DOCKER_COMPOSE) exec spark-master spark-shell

python-shell: ## Acessa Python shell com imports do projeto
	@echo "$(BLUE)üêç Acessando Python shell...$(NC)"
	$(PYTHON) -i -c "import sys; sys.path.insert(0, 'src'); print('Imports: from src.common import *')"

# ============================================================================
# CI/CD
# ============================================================================

ci: lint test ## Executa pipeline de CI (lint + tests)
	@echo "$(GREEN)‚úÖ Pipeline CI conclu√≠do com sucesso!$(NC)"

deploy-prod: ## Deploy para produ√ß√£o
	@echo "$(YELLOW)üöÄ Deploying to production...$(NC)"
	@echo "$(RED)‚ö†Ô∏è  Funcionalidade ainda n√£o implementada$(NC)"

# ============================================================================
# DOCUMENTA√á√ÉO
# ============================================================================

docs: ## Gera documenta√ß√£o do projeto
	@echo "$(BLUE)üìö Gerando documenta√ß√£o...$(NC)"
	cd docs && make html
	@echo "$(GREEN)‚úÖ Documenta√ß√£o gerada em docs/_build/html/$(NC)"

docs-serve: ## Serve documenta√ß√£o localmente
	@echo "$(BLUE)üåê Servindo documenta√ß√£o...$(NC)"
	cd docs/_build/html && $(PYTHON) -m http.server 8000

# ============================================================================
# INFORMA√á√ïES
# ============================================================================

info: ## Mostra informa√ß√µes do projeto
	@echo ""
	@echo "$(BLUE)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(BLUE)‚ïë                                                              ‚ïë$(NC)"
	@echo "$(BLUE)‚ïë              SPTRANS PIPELINE - INFORMA√á√ïES                  ‚ïë$(NC)"
	@echo "$(BLUE)‚ïë                                                              ‚ïë$(NC)"
	@echo "$(BLUE)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@echo "$(YELLOW)üì¶ Projeto:$(NC)       SPTrans Data Pipeline"
	@echo "$(YELLOW)üéØ Objetivo:$(NC)      Pipeline de dados para transporte p√∫blico de SP"
	@echo "$(YELLOW)üèóÔ∏è  Arquitetura:$(NC)  Lakehouse com camadas Bronze/Silver/Gold"
	@echo "$(YELLOW)üîß Stack:$(NC)         Airflow, Spark, PostgreSQL, MinIO, Superset"
	@echo "$(YELLOW)üìä Camadas:$(NC)       Bronze ‚Üí Silver ‚Üí Gold ‚Üí Serving"
	@echo "$(YELLOW)‚ö° Execu√ß√£o:$(NC)      API: 2min | Transforma√ß√£o: 1h | Agrega√ß√£o: 1h"
	@echo ""
	@echo "$(YELLOW)üìñ Documenta√ß√£o:$(NC)  docs/README.md"
	@echo "$(YELLOW)üêõ Issues:$(NC)        GitHub Issues"
	@echo "$(YELLOW)üí¨ Contato:$(NC)       [seu-email]"
	@echo ""

version: ## Mostra vers√µes dos componentes
	@echo "$(BLUE)üìã Vers√µes dos Componentes:$(NC)"
	@echo ""
	@echo "$(YELLOW)Python:$(NC)        $$($(PYTHON) --version)"
	@echo "$(YELLOW)Docker:$(NC)        $$(docker --version)"
	@echo "$(YELLOW)Docker Compose:$(NC) $$($(DOCKER_COMPOSE) --version)"
	@echo ""

# ============================================================================
# DEFAULT
# ============================================================================

.DEFAULT_GOAL := help
